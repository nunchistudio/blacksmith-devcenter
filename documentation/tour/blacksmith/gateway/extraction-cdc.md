---

gateway:
  source:
    schema:
      - key: "name"
        type: "string"
        example: "my-source"
        required: true
        description: |
          The name for the source that will be used across services.

      - key: "driver"
        type: "string"
        required: true
        description: |
          The driver to use for Extracting events from a Change Data Capture
          within a database.

      - key: "connection"
        type: "string"
        example: "ANY_ENV_VAR"
        required: true
        description: |
          The connection string to use to connect to the SQL store.

      - key: "policies"
        type: "object"
        items:
          - key: "extraction"
            type: "object"
            items:
              - key: "timeout"
                type: "integer"
        example:
          extraction:
            timeout: 15
        required: true
        description: |
          The policy to apply by default for all the triggers registered in this
          source.

  trigger:
    schema:
      - key: "name"
        type: "string"
        example: "my-trigger"
        required: true
        description: |
          The name for the trigger that will be used across services.

      - key: "stream"
        type: "string"
        required: true
        description: |
          The driver-specific connection stream to subscribe to for receiving
          event notifications.

      - key: "params"
        type: "url.Values"
        required: true
        description: |
          The driver-specific params used for subscribing to events.

    transformation:
      values:
        user_id: "{% query 'body.user.id' %}"
        subscription_id: "{% query 'body.subscriptions.0.id' %}"
        sku: "{% query 'body.subscriptions.0.sku' %}"
        quantity: "{% query 'body.subscriptions.0.quantity' %}"

---

### Extraction from CDC

A trigger of mode Change Data Capture (`cdc`) **E**xtracts data from an event
within a database in realtime. It is done by subscribing to a *stream* using the
details passed in the source's `defaults.cdc` config and the `config.cdc` of the
said trigger.

Once **E**xtracted (in other words, once a row / document has been inserted,
updated, or deleted), the trigger returns a JSON object with:
- `status`: The status of the **E**xtraction. It is one of `success`, `failure`.
- `id`: The unique identifier of the change event, generated by the database.
- `target`: The table or collection's name where the changes occured.
- `operation`: The operation's type captured.
- `body`: The new row / document formatted in JSON.

Knowing this, a trigger of mode `cdc` could return an object like this:
```json
{
  "status": "success",
  "id": "826177F3AC0000000...",
  "target": "mydatabase.users",
  "operation": "insert",
  "body": {
    "user": {
      "id": "4d6c34df-250e-4fb5-bfb2-27e8d4e9becf",
      "first_name": "John",
      "last_name": "Doe",
      "username": "johndoe",
      "address": {
        "city": "Austin"
      }
    },
    "subscriptions": [
      {
        "id": "206b0e36-0d24-43f7-9e9c-c1fdf2cd4780",
        "name": "Enterprise Edition",
        "sku": "BLACKSMITH_EE",
        "quantity": 1.0
      }
    ]
  }
}
```

This object is then available in the `transformation` object for each integration
configured within the trigger, as described below.
